<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.66">
<link rel="stylesheet" href="fonts/fonts.css"><title data-react-helmet="true">HashMap Lazy vs. Eager | ink! documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="HashMap Lazy vs. Eager | ink! documentation"><meta data-react-helmet="true" name="description" content="In the following we explore the differences between the high-level ink_storage::HashMap"><meta data-react-helmet="true" property="og:description" content="In the following we explore the differences between the high-level ink_storage::HashMap"><meta data-react-helmet="true" property="og:url" content="https://github.com/paritytech/ink/ink-docs/datastructures/hashmap-lazy-eager"><link data-react-helmet="true" rel="shortcut icon" href="/ink-docs/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/paritytech/ink/ink-docs/datastructures/hashmap-lazy-eager"><link rel="stylesheet" href="/ink-docs/styles.25915df3.css">
<link rel="preload" href="/ink-docs/styles.95ffbc63.js" as="script">
<link rel="preload" href="/ink-docs/runtime~main.515953f5.js" as="script">
<link rel="preload" href="/ink-docs/main.5a793521.js" as="script">
<link rel="preload" href="/ink-docs/1.1da62135.js" as="script">
<link rel="preload" href="/ink-docs/2.fca416f2.js" as="script">
<link rel="preload" href="/ink-docs/37.f15770d0.js" as="script">
<link rel="preload" href="/ink-docs/935f2afb.ef44755c.js" as="script">
<link rel="preload" href="/ink-docs/17896441.8799f5f5.js" as="script">
<link rel="preload" href="/ink-docs/5d335ed5.289feab2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/ink-docs/"><img class="navbar__logo" src="/ink-docs/img/logo-black.svg" alt="ink!"><strong class="navbar__title"></strong></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/paritytech/ink" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">ink! GitHub</a><a href="https://github.com/paritytech/ink-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Docs GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/ink-docs/"><img class="navbar__logo" src="/ink-docs/img/logo-black.svg" alt="ink!"><strong class="navbar__title"></strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/paritytech/ink" target="_blank" rel="noopener noreferrer" class="menu__link">ink! GitHub</a></li><li class="menu__list-item"><a href="https://github.com/paritytech/ink-docs" target="_blank" rel="noopener noreferrer" class="menu__link">Docs GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Overview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/why-rust-for-smart-contracts">Why Rust for Smart Contracts?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/how-it-works">How it works â€’ Substrate</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/getting-started/setup">Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/getting-started/creating-an-ink-project">Creating an ink! Project</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/getting-started/building-your-contract">Building Your Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/getting-started/running-substrate">Running a Substrate Node</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/getting-started/deploying-your-contract">Deploying Your Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/getting-started/calling-your-contract">Calling Your Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/getting-started/testing-your-contract">Testing Your Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/getting-started/troubleshooting">Troubleshooting</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Basics</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/contract-template">Contract Template</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/constructors">Constructors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/chain-types">Chain Types</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/storing-values">Storing Values</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/reading-values">Reading Values from Storage</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/mutating-values">Mutating Storage Values</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/events">Events</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/trait-definitions">Trait Definitions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/cross-contract-calling">Cross-Contract Calling</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/basics/off-chain-testing">Off-chain Testing</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Macros &amp; Attributes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/ink-macros-attributes">Overview</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Data Structures</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ink-docs/datastructures/custom">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ink-docs/datastructures/hashmap">HashMap</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/ink-docs/datastructures/hashmap-lazy-eager">HashMap Lazy vs. Eager</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/ink-docs/datastructures/custom-datastructure">Your Custom Datastructure</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Examples</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/examples">Overview</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">cargo-contract CLI</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/cargo-contract-cli">Overview</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Canvas Test Network</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/canvas">Overview</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">FAQ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/ink-docs/faq">Frequently Asked Questions</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">HashMap Lazy vs. Eager</h1></header><div class="markdown"><p>In the following we explore the differences between the high-level <code>ink_storage::collections::HashMap</code>
and the low-level <code>ink_storage::lazy::LazyHashMap</code>. Both provide very similar functionality in that they map some generic key to some storage entity.</p><p>However, their APIs look very different. Whereas the <code>HashMap</code> provides a rich and high-level API that is comparable to that of Rust&#x27;s very own <code>HashMap</code>, the <code>LazyHashMap</code> provides only a fraction of the API and also operates on <code>Option&lt;T&gt;</code> values types instead of <code>T</code> directly. It is more similar Solidity mappings than to Rust&#x27;s <code>HashMap</code>.</p><p>The fundamental difference of both data structures is that <code>HashMap</code> is aware of the keys that have been stored in it and thus can reconstruct exactly which elements and storage regions apply to it. This enables it to provide iteration and automated deletion as well as efficient way to defragment its underlying storage to free some storage space again. This goes very well in the vein of Substrate&#x27;s storage rent model where contracts have to pay for the storage they are using.</p><table><thead><tr><th align="left">Data Structure</th><th align="center">level of abstraction</th><th align="center">caching</th><th align="center">lazy</th><th align="center">element type</th><th align="center">container</th></tr></thead><tbody><tr><td align="left"><code>T</code></td><td align="center">-</td><td align="center">yes</td><td align="center">no</td><td align="center"><code>T</code></td><td align="center">primitive value</td></tr><tr><td align="left"><code>Lazy&lt;T&gt;</code></td><td align="center">high-level</td><td align="center">yes</td><td align="center">yes</td><td align="center"><code>T</code></td><td align="center">single element container</td></tr><tr><td align="left"><code>LazyCell&lt;T&gt;</code></td><td align="center">low-level</td><td align="center">yes</td><td align="center">yes</td><td align="center"><code>Option&lt;T&gt;</code></td><td align="center">single element, no container</td></tr><tr><td align="left"><code>Vec&lt;T&gt;</code></td><td align="center">high-level</td><td align="center">yes</td><td align="center">yes</td><td align="center"><code>T</code></td><td align="center">Rust vector-like container</td></tr><tr><td align="left"><code>LazyIndexMap&lt;T&gt;</code></td><td align="center">low-level</td><td align="center">yes</td><td align="center">yes</td><td align="center"><code>Option&lt;T&gt;</code></td><td align="center">similar to Solidity mapping</td></tr><tr><td align="left"><code>HashMap&lt;K, V&gt;</code></td><td align="center">high-level</td><td align="center">yes</td><td align="center">yes</td><td align="center"><code>V</code> (key type <code>K</code>)</td><td align="center">Rust map-like container</td></tr><tr><td align="left"><code>LazyHashMap&lt;K, V&gt;</code></td><td align="center">low-level</td><td align="center">yes</td><td align="center">yes</td><td align="center"><code>Option&lt;V&gt;</code> (key type <code>K</code>)</td><td align="center">similar to Solidity mapping</td></tr></tbody></table><p>There are many more! For more information about the specifics please take a look into <a href="https://paritytech.github.io/ink/ink_storage/" target="_blank" rel="noopener noreferrer">the <code>ink_storage</code> crate documentation</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="spread--packed-modes"></a>Spread &amp; Packed Modes<a aria-hidden="true" tabindex="-1" class="hash-link" href="#spread--packed-modes" title="Direct link to heading">#</a></h3><p>Storing or loading complex data structures to and from contract storage can be done in many different ways. You could store all information into a single storage cell or you could try to store all information into as many different cells as possible. Both strategies have pros and cons under different conditions.</p><p>For example it might be a very good idea to store all the information under the same cell if all the information is very compact. For example when we are dealing with a byte vector that is expected to never be larger than approx a thousand elements it would probably be more efficient if we store all those thousand bytes in the same cell and especially if we often access many of those (or all) in our contract messages.</p><p>On the other hand spreading information across as many cells as possible might be much more efficient if we are dealing with big data structures, a lot of information that is not compact, or when messages that operate on the data always only need a small fraction of the whole data.
An example for this use case is if you have a vector of user accounts where each account stores potentially a lot of information, e.g. a 32-byte hash etc and where our messages only every operate on only a few of those at a time.</p><p>The <code>ink_storage</code> crate provides the user full control over the strategy or a mix of these two root strategies through some fundamental abstractions that we are briefly presenting to you.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="default-spreading-mode"></a>Default: Spreading Mode<a aria-hidden="true" tabindex="-1" class="hash-link" href="#default-spreading-mode" title="Direct link to heading">#</a></h3><p>By default ink! spreads information to as many cells as possible. For example if you have the following <code>#[ink(storage)]</code> struct every field will live in its own single storage cell. Note that for <code>c</code> all 32 bytes will share the same cell!</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-rust codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#2a2734;color:#9a86fd"><div class="token-line" style="color:#9a86fd"><span class="token plain">#[ink(storage)]</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct Spreaded {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    a: i32,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    b: ink_storage::Lazy&lt;i32&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    c: [u8; 32],</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="packing-storage"></a>Packing Storage<a aria-hidden="true" tabindex="-1" class="hash-link" href="#packing-storage" title="Direct link to heading">#</a></h3><p>We can alter this behaviour by using the <code>ink_storage::Pack</code> abstraction:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-rust codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#2a2734;color:#9a86fd"><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct Spreaded {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    a: i32,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    b: ink_storage::Lazy&lt;i32&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    c: [u8; 32],</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">#[ink(storage)]</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct Packed {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    packed: ink_storage::Pack&lt;Spreaded&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div></div></div></div></div><p>Now all fields of <code>Spreaded</code> will share the same storage cell. This means whenever one of them is stored to or loaded from the contract storage, all of them are stored or loaded. A user has to choose wisely what mode of operation is more suitable for their contract.</p><p>These abstractions can be combined in various ways, yielding full control to the users. For example, in the following only <code>a</code> and <code>b</code> share a common storage cell while <code>c</code> lives in its own:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-rust codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#2a2734;color:#9a86fd"><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct Spreaded {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    a: i32,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    b: ink_storage::Lazy&lt;i32&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">#[ink(storage)]</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct Packed {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    packed: ink_storage::Pack&lt;Spreaded&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    c: [u8; 32],</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="spreading-array-cells"></a>Spreading Array Cells<a aria-hidden="true" tabindex="-1" class="hash-link" href="#spreading-array-cells" title="Direct link to heading">#</a></h3><p>If we prefer to store all bytes of <code>c</code> into their own storage cell we can make use of the <code>SmallVec</code> data structure. The <code>SmallVec</code> is a high-level data structure that allows to efficiently organize a fixed number of elements similar to a Rust array. However, unlike a Rust array it acts lazily upon the storage and spreads its elements into different cells.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-rust codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#2a2734;color:#9a86fd"><div class="token-line" style="color:#9a86fd"><span class="token plain">use typenum::U32;</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct Spreaded {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    a: i32,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    b: ink_storage::Lazy&lt;i32&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">#[ink(storage)]</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct Packed {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    packed: ink_storage::Pack&lt;Spreaded&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    c: SmallVec&lt;u8, U32&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="opting-out-of-storage"></a>Opting-out of Storage<a aria-hidden="true" tabindex="-1" class="hash-link" href="#opting-out-of-storage" title="Direct link to heading">#</a></h3><p>If you are in need of storing some temporary information across method and message boundaries ink! will have your back with the <code>ink_storage::Memory</code> abstraction. It allows you to simply opt-out of using the storage for the wrapped entity at all and thus is very similar to Solidity&#x27;s very own <code>memory</code> annotation.</p><p>An example below:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-rust codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#2a2734;color:#9a86fd"><div class="token-line" style="color:#9a86fd"><span class="token plain">#[ink(storage)]</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct OptedOut {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    a: i32,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    b: ink_storage::Lazy&lt;i32&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    c: ink_storage::Memory&lt;i32&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div></div></div></div></div><p>The the above example <code>a</code> and <code>b</code> are normal storage entities, however, <code>c</code> on the other hand side will never load from or store to contract storage and will always be reset to the default value of its <code>i32</code> type for every contract call.
It can be accesses from all ink! messages or methods via <code>self.c</code> but will never manipulate the contract storage and thus acts wonderfully as some shared local information.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="dynamic-storage-allocator"></a>Dynamic Storage Allocator<a aria-hidden="true" tabindex="-1" class="hash-link" href="#dynamic-storage-allocator" title="Direct link to heading">#</a></h3><p>In the previous section we have seen how the default mode of operation is to spread information and how we can opt-in to packing information into single cells via <code>ink_storage::Packed</code>.</p><p>However, what if we wanted to store a vector of a vector of <code>i32</code> for example?
Naturally a user would try to construct this as follows:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-rust codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#2a2734;color:#9a86fd"><div class="token-line" style="color:#9a86fd"><span class="token plain">use ink_storage::Vec as StorageVec;</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">#[ink(storage)]</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct Matrix {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    values: StorageVec&lt;StorageVec&lt;i32&gt;&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div></div></div></div></div><p>However, this will fail compilation with an error indicating that <code>StorageVec&lt;T&gt;</code> requires for its <code>T</code> to be packed (<code>T: PackedLayout</code>) which <code>StorageVec&lt;T&gt;</code> itself does not since it always stores all of its elements into different cells. The same applies to many other storage data sturctures provided by <code>ink_storage</code> and is a trade-off the ink! team decided for the case of efficiency of the overall system.
Instead what a user can do in order to get their vector-of-vector to be working is to make use of ink!&#x27;s dynamic storage allocator capabilities.</p><p>For this the contract author has to first enable the feature via:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-rust codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#2a2734;color:#9a86fd"><div class="token-line" style="color:#9a86fd"><span class="token plain">use ink_lang as ink;</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">#[ink::contract(dynamic_storage_allocator = true)]</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">mod matrix {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    // contract code ...</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div></div></div></div></div><p>And then we can define our <code>Matrix</code> <code>#[ink(storage)]</code> as follows:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-rust codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="background-color:#2a2734;color:#9a86fd"><div class="token-line" style="color:#9a86fd"><span class="token plain">use ink_storage::{</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    Vec as StorageVec,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    Box as StorageBox,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">};</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">#[ink(storage)]</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">pub struct Matrix {</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">    values: StorageVec&lt;StorageBox&lt;StorageVec&lt;i32&gt;&gt;&gt;,</span></div><div class="token-line" style="color:#9a86fd"><span class="token plain">}</span></div></div></div></div></div><p>With <code>ink_storage::Box&lt;T&gt;</code> we can use a <code>T: SpreadLayout</code> as if it was <code>T: PackedLayout</code> since the <code>ink_storage::Box&lt;T&gt;</code> itself suffices the requirements and can be put into a single contract storage cell. The whole concept works quite similar to how Rust&#x27;s <code>Box</code> works: by an indirection - contract authors are therefore advised to make use of dynamic storage allocator capabilities only if other ways of dealing with ones problems are not applicable.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="custom-data-sturctures"></a>Custom Data Sturctures<a aria-hidden="true" tabindex="-1" class="hash-link" href="#custom-data-sturctures" title="Direct link to heading">#</a></h3><p>While the <code>ink_storage</code> crate provides tons of useful utilities and data structures to organize and manipulate the contract&#x27;s storage contract authors are not limited by its capabilities. By implementing the core <code>SpreadLayout</code> and <code>PackedLayout</code> traits users are able to define their very own custom storage data structures with their own set of requirement and features that work along the <code>ink_storage</code> data structures as long as they fulfill the mere requirements stated by those two traits.</p><p>In the future we plan on providing some more ink! workshops and tutorials guiding the approach to design and implement a custom storage data structure.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="in-summary"></a>In Summary<a aria-hidden="true" tabindex="-1" class="hash-link" href="#in-summary" title="Direct link to heading">#</a></h3><p>The new <code>ink_storage</code> crate provides everything you need to operate on your contract&#x27;s storage.
There are low-level and high-level data structures depending on your need of control.
All provided data structures operate lazily on the contract&#x27;s storage and cache their reads and writes for a more gas efficient storage access.
Users should prefer high-level data structures found in the <code>collections</code> module over the low-level data structures found in the <code>lazy</code> module.
For a list of all the new storage data structure visit <a href="https://paritytech.github.io/ink/ink_storage/" target="_blank" rel="noopener noreferrer"><code>ink_storage</code>&#x27;s documentation</a>.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/ink-docs/edit/master/docs/datastructures/hashmap-impls.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/ink-docs/datastructures/hashmap"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« HashMap</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/ink-docs/datastructures/custom-datastructure"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Your Custom Datastructure Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#spread--packed-modes" class="table-of-contents__link">Spread &amp; Packed Modes</a></li><li><a href="#default-spreading-mode" class="table-of-contents__link">Default: Spreading Mode</a></li><li><a href="#packing-storage" class="table-of-contents__link">Packing Storage</a></li><li><a href="#spreading-array-cells" class="table-of-contents__link">Spreading Array Cells</a></li><li><a href="#opting-out-of-storage" class="table-of-contents__link">Opting-out of Storage</a></li><li><a href="#dynamic-storage-allocator" class="table-of-contents__link">Dynamic Storage Allocator</a></li><li><a href="#custom-data-sturctures" class="table-of-contents__link">Custom Data Sturctures</a></li><li><a href="#in-summary" class="table-of-contents__link">In Summary</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/ink-docs/styles.95ffbc63.js"></script>
<script src="/ink-docs/runtime~main.515953f5.js"></script>
<script src="/ink-docs/main.5a793521.js"></script>
<script src="/ink-docs/1.1da62135.js"></script>
<script src="/ink-docs/2.fca416f2.js"></script>
<script src="/ink-docs/37.f15770d0.js"></script>
<script src="/ink-docs/935f2afb.ef44755c.js"></script>
<script src="/ink-docs/17896441.8799f5f5.js"></script>
<script src="/ink-docs/5d335ed5.289feab2.js"></script>
</body>
</html>